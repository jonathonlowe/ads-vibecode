"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DEFAULT_OPTIONS = void 0;
Object.defineProperty(exports, "PRIORITY", {
  enumerable: true,
  get: function () {
    return _constants2.PRIORITY;
  }
});
Object.defineProperty(exports, "isLoaderError", {
  enumerable: true,
  get: function () {
    return _errors.isLoaderError;
  }
});
exports.lazy = lazy;
exports.lazyAfterPaint = lazyAfterPaint;
exports.lazyForPaint = lazyForPaint;
var _manifest = require("@react-loosely-lazy/manifest");
var _config = require("../config");
var _constants = require("../constants");
var _utils = require("../utils");
var _constants2 = require("./constants");
var _client = require("./components/client");
var _server = require("./components/server");
var _deferred = require("./deferred");
var _preload = require("./preload");
var _retry = require("./retry");
var _errors = require("./errors");
function lazyProxy(loader, {
  defer = _constants.PHASE.PAINT,
  moduleId = '',
  ssr = true
} = {}) {
  const isServer = (0, _utils.isNodeEnvironment)();
  const dataLazyId = (0, _utils.hash)(moduleId);
  const LazyInternal = isServer ? (0, _server.createComponentServer)({
    dataLazyId,
    defer,
    loader: loader,
    moduleId,
    ssr
  }) : (0, _client.createComponentClient)({
    dataLazyId,
    defer,
    // We separate the preload from the retryable request, as we do not want the preload to contribute to retry
    // attempts, when the the loader fallback is used
    deferred: (0, _deferred.createDeferred)({
      loader: () => {
        const {
          retry: maxAttempts
        } = (0, _config.getConfig)();
        return (0, _retry.retry)(loader, {
          delay: _constants2.RETRY_DELAY,
          factor: _constants2.RETRY_FACTOR,
          maxAttempts
        });
      },
      preload: loader
    }),
    moduleId
  });
  LazyInternal.displayName = `Lazy(${(0, _utils.displayNameFromId)(moduleId)})`;

  /**
   * Allows getting module chunks urls
   */
  const getAssetUrls = () => {
    const {
      manifest
    } = (0, _config.getConfig)();
    return (0, _manifest.getAssetUrlsFromId)(manifest, moduleId);
  };

  /**
   * Allows imperatively preload/ prefetch the module chunk asset
   */
  const preload = priority => {
    const p = priority !== null && priority !== void 0 ? priority : defer === _constants.PHASE.PAINT ? _constants2.PRIORITY.HIGH : _constants2.PRIORITY.LOW;
    return (0, _preload.preloadAsset)({
      loader,
      moduleId,
      priority: p
    });
  };
  return Object.assign(LazyInternal, {
    getAssetUrls,
    preload
  });
}
const DEFAULT_OPTIONS = exports.DEFAULT_OPTIONS = {
  lazyForPaint: {
    ssr: true,
    defer: _constants.PHASE.PAINT
  },
  lazyAfterPaint: {
    ssr: true,
    defer: _constants.PHASE.AFTER_PAINT
  },
  lazy: {
    ssr: false,
    defer: _constants.PHASE.LAZY
  }
};
function lazyForPaint(loader, opts) {
  return lazyProxy(loader, {
    ...DEFAULT_OPTIONS.lazyForPaint,
    ...(opts || {})
  });
}
function lazyAfterPaint(loader, opts) {
  return lazyProxy(loader, {
    ...DEFAULT_OPTIONS.lazyAfterPaint,
    ...(opts || {})
  });
}
function lazy(loader, opts) {
  return lazyProxy(loader, {
    ...DEFAULT_OPTIONS.lazy,
    ...(opts || {})
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbWFuaWZlc3QiLCJyZXF1aXJlIiwiX2NvbmZpZyIsIl9jb25zdGFudHMiLCJfdXRpbHMiLCJfY29uc3RhbnRzMiIsIl9jbGllbnQiLCJfc2VydmVyIiwiX2RlZmVycmVkIiwiX3ByZWxvYWQiLCJfcmV0cnkiLCJfZXJyb3JzIiwibGF6eVByb3h5IiwibG9hZGVyIiwiZGVmZXIiLCJQSEFTRSIsIlBBSU5UIiwibW9kdWxlSWQiLCJzc3IiLCJpc1NlcnZlciIsImlzTm9kZUVudmlyb25tZW50IiwiZGF0YUxhenlJZCIsImhhc2giLCJMYXp5SW50ZXJuYWwiLCJjcmVhdGVDb21wb25lbnRTZXJ2ZXIiLCJjcmVhdGVDb21wb25lbnRDbGllbnQiLCJkZWZlcnJlZCIsImNyZWF0ZURlZmVycmVkIiwicmV0cnkiLCJtYXhBdHRlbXB0cyIsImdldENvbmZpZyIsImRlbGF5IiwiUkVUUllfREVMQVkiLCJmYWN0b3IiLCJSRVRSWV9GQUNUT1IiLCJwcmVsb2FkIiwiZGlzcGxheU5hbWUiLCJkaXNwbGF5TmFtZUZyb21JZCIsImdldEFzc2V0VXJscyIsIm1hbmlmZXN0IiwiZ2V0QXNzZXRVcmxzRnJvbUlkIiwicHJpb3JpdHkiLCJwIiwiUFJJT1JJVFkiLCJISUdIIiwiTE9XIiwicHJlbG9hZEFzc2V0IiwiT2JqZWN0IiwiYXNzaWduIiwiREVGQVVMVF9PUFRJT05TIiwiZXhwb3J0cyIsImxhenlGb3JQYWludCIsImxhenlBZnRlclBhaW50IiwiQUZURVJfUEFJTlQiLCJsYXp5IiwiTEFaWSIsIm9wdHMiXSwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGF6eS9pbmRleC50c3giXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0QXNzZXRVcmxzRnJvbUlkIH0gZnJvbSAnQHJlYWN0LWxvb3NlbHktbGF6eS9tYW5pZmVzdCc7XG5pbXBvcnQgeyBDb21wb25lbnRQcm9wcywgQ29tcG9uZW50VHlwZSwgRnVuY3Rpb25Db21wb25lbnQgfSBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCB7IGdldENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZyc7XG5pbXBvcnQgeyBQSEFTRSB9IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBoYXNoLCBkaXNwbGF5TmFtZUZyb21JZCwgaXNOb2RlRW52aXJvbm1lbnQgfSBmcm9tICcuLi91dGlscyc7XG5cbmltcG9ydCB7IFBSSU9SSVRZLCBSRVRSWV9ERUxBWSwgUkVUUllfRkFDVE9SIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgY3JlYXRlQ29tcG9uZW50Q2xpZW50IH0gZnJvbSAnLi9jb21wb25lbnRzL2NsaWVudCc7XG5pbXBvcnQgeyBjcmVhdGVDb21wb25lbnRTZXJ2ZXIgfSBmcm9tICcuL2NvbXBvbmVudHMvc2VydmVyJztcbmltcG9ydCB7IGNyZWF0ZURlZmVycmVkIH0gZnJvbSAnLi9kZWZlcnJlZCc7XG5pbXBvcnQgeyBDbGllbnRMb2FkZXIsIExvYWRlciwgU2VydmVyTG9hZGVyIH0gZnJvbSAnLi9sb2FkZXInO1xuaW1wb3J0IHsgcHJlbG9hZEFzc2V0IH0gZnJvbSAnLi9wcmVsb2FkJztcbmltcG9ydCB7IHJldHJ5IH0gZnJvbSAnLi9yZXRyeSc7XG5pbXBvcnQgdHlwZSB7IExhenlPcHRpb25zLCBMYXp5Q29tcG9uZW50LCBQcmVsb2FkUHJpb3JpdHkgfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IHsgUFJJT1JJVFkgfTtcbmV4cG9ydCB0eXBlIHsgTGF6eU9wdGlvbnMsIExhenlDb21wb25lbnQgfTtcblxuZnVuY3Rpb24gbGF6eVByb3h5PEMgZXh0ZW5kcyBDb21wb25lbnRUeXBlPGFueT4+KFxuICBsb2FkZXI6IExvYWRlcjxDPixcbiAgeyBkZWZlciA9IFBIQVNFLlBBSU5ULCBtb2R1bGVJZCA9ICcnLCBzc3IgPSB0cnVlIH06IExhenlPcHRpb25zID0ge31cbik6IExhenlDb21wb25lbnQ8Qz4ge1xuICBjb25zdCBpc1NlcnZlciA9IGlzTm9kZUVudmlyb25tZW50KCk7XG4gIGNvbnN0IGRhdGFMYXp5SWQgPSBoYXNoKG1vZHVsZUlkKTtcblxuICBjb25zdCBMYXp5SW50ZXJuYWw6IEZ1bmN0aW9uQ29tcG9uZW50PENvbXBvbmVudFByb3BzPEM+PiA9IGlzU2VydmVyXG4gICAgPyBjcmVhdGVDb21wb25lbnRTZXJ2ZXIoe1xuICAgICAgICBkYXRhTGF6eUlkLFxuICAgICAgICBkZWZlcixcbiAgICAgICAgbG9hZGVyOiBsb2FkZXIgYXMgU2VydmVyTG9hZGVyPEM+LFxuICAgICAgICBtb2R1bGVJZCxcbiAgICAgICAgc3NyLFxuICAgICAgfSlcbiAgICA6IGNyZWF0ZUNvbXBvbmVudENsaWVudCh7XG4gICAgICAgIGRhdGFMYXp5SWQsXG4gICAgICAgIGRlZmVyLFxuICAgICAgICAvLyBXZSBzZXBhcmF0ZSB0aGUgcHJlbG9hZCBmcm9tIHRoZSByZXRyeWFibGUgcmVxdWVzdCwgYXMgd2UgZG8gbm90IHdhbnQgdGhlIHByZWxvYWQgdG8gY29udHJpYnV0ZSB0byByZXRyeVxuICAgICAgICAvLyBhdHRlbXB0cywgd2hlbiB0aGUgdGhlIGxvYWRlciBmYWxsYmFjayBpcyB1c2VkXG4gICAgICAgIGRlZmVycmVkOiBjcmVhdGVEZWZlcnJlZCh7XG4gICAgICAgICAgbG9hZGVyOiAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHJldHJ5OiBtYXhBdHRlbXB0cyB9ID0gZ2V0Q29uZmlnKCk7XG5cbiAgICAgICAgICAgIHJldHVybiByZXRyeShsb2FkZXIgYXMgQ2xpZW50TG9hZGVyPEM+LCB7XG4gICAgICAgICAgICAgIGRlbGF5OiBSRVRSWV9ERUxBWSxcbiAgICAgICAgICAgICAgZmFjdG9yOiBSRVRSWV9GQUNUT1IsXG4gICAgICAgICAgICAgIG1heEF0dGVtcHRzLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBwcmVsb2FkOiBsb2FkZXIgYXMgQ2xpZW50TG9hZGVyPEM+LFxuICAgICAgICB9KSxcbiAgICAgICAgbW9kdWxlSWQsXG4gICAgICB9KTtcblxuICBMYXp5SW50ZXJuYWwuZGlzcGxheU5hbWUgPSBgTGF6eSgke2Rpc3BsYXlOYW1lRnJvbUlkKG1vZHVsZUlkKX0pYDtcblxuICAvKipcbiAgICogQWxsb3dzIGdldHRpbmcgbW9kdWxlIGNodW5rcyB1cmxzXG4gICAqL1xuICBjb25zdCBnZXRBc3NldFVybHMgPSAoKSA9PiB7XG4gICAgY29uc3QgeyBtYW5pZmVzdCB9ID0gZ2V0Q29uZmlnKCk7XG5cbiAgICByZXR1cm4gZ2V0QXNzZXRVcmxzRnJvbUlkKG1hbmlmZXN0LCBtb2R1bGVJZCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIEFsbG93cyBpbXBlcmF0aXZlbHkgcHJlbG9hZC8gcHJlZmV0Y2ggdGhlIG1vZHVsZSBjaHVuayBhc3NldFxuICAgKi9cbiAgY29uc3QgcHJlbG9hZCA9IChwcmlvcml0eT86IFByZWxvYWRQcmlvcml0eSkgPT4ge1xuICAgIGNvbnN0IHAgPVxuICAgICAgcHJpb3JpdHkgPz8gKGRlZmVyID09PSBQSEFTRS5QQUlOVCA/IFBSSU9SSVRZLkhJR0ggOiBQUklPUklUWS5MT1cpO1xuXG4gICAgcmV0dXJuIHByZWxvYWRBc3NldCh7IGxvYWRlciwgbW9kdWxlSWQsIHByaW9yaXR5OiBwIH0pO1xuICB9O1xuXG4gIHJldHVybiBPYmplY3QuYXNzaWduKExhenlJbnRlcm5hbCwge1xuICAgIGdldEFzc2V0VXJscyxcbiAgICBwcmVsb2FkLFxuICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfT1BUSU9OUzoge1xuICBba2V5OiBzdHJpbmddOiB7IHNzcjogYm9vbGVhbjsgZGVmZXI6IG51bWJlciB9O1xufSA9IHtcbiAgbGF6eUZvclBhaW50OiB7IHNzcjogdHJ1ZSwgZGVmZXI6IFBIQVNFLlBBSU5UIH0sXG4gIGxhenlBZnRlclBhaW50OiB7IHNzcjogdHJ1ZSwgZGVmZXI6IFBIQVNFLkFGVEVSX1BBSU5UIH0sXG4gIGxhenk6IHsgc3NyOiBmYWxzZSwgZGVmZXI6IFBIQVNFLkxBWlkgfSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBsYXp5Rm9yUGFpbnQ8QyBleHRlbmRzIENvbXBvbmVudFR5cGU8YW55Pj4oXG4gIGxvYWRlcjogTG9hZGVyPEM+LFxuICBvcHRzPzogTGF6eU9wdGlvbnNcbikge1xuICByZXR1cm4gbGF6eVByb3h5PEM+KGxvYWRlciwge1xuICAgIC4uLkRFRkFVTFRfT1BUSU9OUy5sYXp5Rm9yUGFpbnQsXG4gICAgLi4uKG9wdHMgfHwge30pLFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxhenlBZnRlclBhaW50PEMgZXh0ZW5kcyBDb21wb25lbnRUeXBlPGFueT4+KFxuICBsb2FkZXI6IExvYWRlcjxDPixcbiAgb3B0cz86IExhenlPcHRpb25zXG4pIHtcbiAgcmV0dXJuIGxhenlQcm94eTxDPihsb2FkZXIsIHtcbiAgICAuLi5ERUZBVUxUX09QVElPTlMubGF6eUFmdGVyUGFpbnQsXG4gICAgLi4uKG9wdHMgfHwge30pLFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGxhenk8QyBleHRlbmRzIENvbXBvbmVudFR5cGU8YW55Pj4oXG4gIGxvYWRlcjogTG9hZGVyPEM+LFxuICBvcHRzPzogTGF6eU9wdGlvbnNcbikge1xuICByZXR1cm4gbGF6eVByb3h5PEM+KGxvYWRlciwge1xuICAgIC4uLkRFRkFVTFRfT1BUSU9OUy5sYXp5LFxuICAgIC4uLihvcHRzIHx8IHt9KSxcbiAgfSk7XG59XG5cbmV4cG9ydCB0eXBlIHsgQ2xpZW50TG9hZGVyLCBMb2FkZXIsIFNlcnZlckxvYWRlciB9O1xuZXhwb3J0IHsgaXNMb2FkZXJFcnJvciB9IGZyb20gJy4vZXJyb3JzJztcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBQUEsU0FBQSxHQUFBQyxPQUFBO0FBR0EsSUFBQUMsT0FBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsVUFBQSxHQUFBRixPQUFBO0FBQ0EsSUFBQUcsTUFBQSxHQUFBSCxPQUFBO0FBRUEsSUFBQUksV0FBQSxHQUFBSixPQUFBO0FBQ0EsSUFB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