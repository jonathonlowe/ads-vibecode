import { getAssetUrlsFromId } from '@react-loosely-lazy/manifest';
import { noopCleanup } from '../../cleanup';
import { getConfig } from '../../config';
import { isNodeEnvironment } from '../../utils';
import { PRIORITY } from '../constants';
import { insertLinkTag } from './utils';
import { GlobalReactLooselyLazyProfiler } from '../../profiler';
export function manifestPreloadStrategy({
  moduleId,
  rel
}) {
  const {
    manifest
  } = getConfig();
  const assets = getAssetUrlsFromId(manifest, moduleId);
  if (!assets) {
    throw new Error('Unsupported preload strategy');
  }
  const cleanupLinkTags = assets.map(url => insertLinkTag(url, rel));
  return () => {
    for (const cleanupLinkTag of cleanupLinkTags) {
      cleanupLinkTag();
    }
  };
}
const fakePromise = {
  then: () => fakePromise,
  catch: () => fakePromise,
  finally: () => fakePromise
};
export function webpackPreloadStrategy({
  loader,
  rel
}) {
  if (typeof __webpack_require__ === 'undefined' || typeof __webpack_get_script_filename__ === 'undefined') throw new Error('Unsupported preload strategy');

  // Replace requireEnsure to create link tags instead of scripts
  const requireEnsure = __webpack_require__.e;
  const cleanupLinkTags = [];
  __webpack_require__.e = function requirePreload(chunkId) {
    const href = __webpack_get_script_filename__(chunkId);
    cleanupLinkTags.push(insertLinkTag(href, rel));
    return fakePromise;
  };
  try {
    loader();
  } catch (err) {
    // Ignore any errors
  }

  // Restore real webpack require ensure
  __webpack_require__.e = requireEnsure;
  return () => {
    for (const cleanupLinkTag of cleanupLinkTags) {
      cleanupLinkTag();
    }
  };
}
export function loaderPreloadStrategy({
  loader
}) {
  loader();
  return noopCleanup;
}
export function preloadAsset({
  loader,
  moduleId,
  priority
}) {
  var _GlobalReactLooselyLa;
  if (isNodeEnvironment()) return noopCleanup;
  (_GlobalReactLooselyLa = GlobalReactLooselyLazyProfiler.current) == null || _GlobalReactLooselyLa.onPreload(moduleId, priority);
  const rel = priority === PRIORITY.HIGH ? 'preload' : 'prefetch';
  const preloadStrategies = [manifestPreloadStrategy, webpackPreloadStrategy, loaderPreloadStrategy];
  for (const strategy of preloadStrategies) {
    try {
      return strategy({
        loader,
        moduleId,
        rel
      });
    } catch (_) {
      // Try next strategy...
    }
  }
  return noopCleanup;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJnZXRBc3NldFVybHNGcm9tSWQiLCJub29wQ2xlYW51cCIsImdldENvbmZpZyIsImlzTm9kZUVudmlyb25tZW50IiwiUFJJT1JJVFkiLCJpbnNlcnRMaW5rVGFnIiwiR2xvYmFsUmVhY3RMb29zZWx5TGF6eVByb2ZpbGVyIiwibWFuaWZlc3RQcmVsb2FkU3RyYXRlZ3kiLCJtb2R1bGVJZCIsInJlbCIsIm1hbmlmZXN0IiwiYXNzZXRzIiwiRXJyb3IiLCJjbGVhbnVwTGlua1RhZ3MiLCJtYXAiLCJ1cmwiLCJjbGVhbnVwTGlua1RhZyIsImZha2VQcm9taXNlIiwidGhlbiIsImNhdGNoIiwiZmluYWxseSIsIndlYnBhY2tQcmVsb2FkU3RyYXRlZ3kiLCJsb2FkZXIiLCJfX3dlYnBhY2tfcmVxdWlyZV9fIiwiX193ZWJwYWNrX2dldF9zY3JpcHRfZmlsZW5hbWVfXyIsInJlcXVpcmVFbnN1cmUiLCJlIiwicmVxdWlyZVByZWxvYWQiLCJjaHVua0lkIiwiaHJlZiIsInB1c2giLCJlcnIiLCJsb2FkZXJQcmVsb2FkU3RyYXRlZ3kiLCJwcmVsb2FkQXNzZXQiLCJwcmlvcml0eSIsIl9HbG9iYWxSZWFjdExvb3NlbHlMYSIsImN1cnJlbnQiLCJvblByZWxvYWQiLCJISUdIIiwicHJlbG9hZFN0cmF0ZWdpZXMiLCJzdHJhdGVneSIsIl8iXSwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGF6eS9wcmVsb2FkL2luZGV4LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldEFzc2V0VXJsc0Zyb21JZCB9IGZyb20gJ0ByZWFjdC1sb29zZWx5LWxhenkvbWFuaWZlc3QnO1xuXG5pbXBvcnQgeyBub29wQ2xlYW51cCB9IGZyb20gJy4uLy4uL2NsZWFudXAnO1xuaW1wb3J0IHR5cGUgeyBDbGVhbnVwIH0gZnJvbSAnLi4vLi4vY2xlYW51cCc7XG5pbXBvcnQgeyBnZXRDb25maWcgfSBmcm9tICcuLi8uLi9jb25maWcnO1xuaW1wb3J0IHsgaXNOb2RlRW52aXJvbm1lbnQgfSBmcm9tICcuLi8uLi91dGlscyc7XG5cbmltcG9ydCB7IFBSSU9SSVRZIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IExvYWRlciB9IGZyb20gJy4uL2xvYWRlcic7XG5pbXBvcnQgeyBQcmVsb2FkUHJpb3JpdHkgfSBmcm9tICcuLi90eXBlcyc7XG5cbmltcG9ydCB7IGluc2VydExpbmtUYWcgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IEdsb2JhbFJlYWN0TG9vc2VseUxhenlQcm9maWxlciB9IGZyb20gJy4uLy4uL3Byb2ZpbGVyJztcblxuZGVjbGFyZSBjb25zdCBfX3dlYnBhY2tfcmVxdWlyZV9fOiBhbnk7XG5kZWNsYXJlIGZ1bmN0aW9uIF9fd2VicGFja19nZXRfc2NyaXB0X2ZpbGVuYW1lX18oY2h1bmtJZDogc3RyaW5nKTogc3RyaW5nO1xuXG5leHBvcnQgdHlwZSB7IENsZWFudXAgfTtcblxudHlwZSBQcmVsb2FkU3RyYXRlZ3lPcHRpb25zID0ge1xuICBsb2FkZXI6IExvYWRlcjx1bmtub3duPjtcbiAgbW9kdWxlSWQ6IHN0cmluZztcbiAgcmVsOiBzdHJpbmc7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gbWFuaWZlc3RQcmVsb2FkU3RyYXRlZ3koe1xuICBtb2R1bGVJZCxcbiAgcmVsLFxufTogUGljazxQcmVsb2FkU3RyYXRlZ3lPcHRpb25zLCAnbW9kdWxlSWQnIHwgJ3JlbCc+KTogQ2xlYW51cCB7XG4gIGNvbnN0IHsgbWFuaWZlc3QgfSA9IGdldENvbmZpZygpO1xuICBjb25zdCBhc3NldHMgPSBnZXRBc3NldFVybHNGcm9tSWQobWFuaWZlc3QsIG1vZHVsZUlkKTtcbiAgaWYgKCFhc3NldHMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vuc3VwcG9ydGVkIHByZWxvYWQgc3RyYXRlZ3knKTtcbiAgfVxuXG4gIGNvbnN0IGNsZWFudXBMaW5rVGFncyA9IGFzc2V0cy5tYXAodXJsID0+IGluc2VydExpbmtUYWcodXJsLCByZWwpKTtcblxuICByZXR1cm4gKCkgPT4ge1xuICAgIGZvciAoY29uc3QgY2xlYW51cExpbmtUYWcgb2YgY2xlYW51cExpbmtUYWdzKSB7XG4gICAgICBjbGVhbnVwTGlua1RhZygpO1xuICAgIH1cbiAgfTtcbn1cblxuY29uc3QgZmFrZVByb21pc2UgPSB7XG4gIHRoZW46ICgpID0+IGZha2VQcm9taXNlLFxuICBjYXRjaDogKCkgPT4gZmFrZVByb21pc2UsXG4gIGZpbmFsbHk6ICgpID0+IGZha2VQcm9taXNlLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHdlYnBhY2tQcmVsb2FkU3RyYXRlZ3koe1xuICBsb2FkZXIsXG4gIHJlbCxcbn06IFBpY2s8UHJlbG9hZFN0cmF0ZWd5T3B0aW9ucywgJ2xvYWRlcicgfCAncmVsJz4pOiBDbGVhbnVwIHtcbiAgaWYgKFxuICAgIHR5cGVvZiBfX3dlYnBhY2tfcmVxdWlyZV9fID09PSAndW5kZWZpbmVkJyB8fFxuICAgIHR5cGVvZiBfX3dlYnBhY2tfZ2V0X3NjcmlwdF9maWxlbmFtZV9fID09PSAndW5kZWZpbmVkJ1xuICApXG4gICAgdGhyb3cgbmV3IEVycm9yKCdVbnN1cHBvcnRlZCBwcmVsb2FkIHN0cmF0ZWd5Jyk7XG5cbiAgLy8gUmVwbGFjZSByZXF1aXJlRW5zdXJlIHRvIGNyZWF0ZSBsaW5rIHRhZ3MgaW5zdGVhZCBvZiBzY3JpcHRzXG4gIGNvbnN0IHJlcXVpcmVFbnN1cmUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fLmU7XG4gIGNvbnN0IGNsZWFudXBMaW5rVGFnczogQ2xlYW51cFtdID0gW107XG4gIF9fd2VicGFja19yZXF1aXJlX18uZSA9IGZ1bmN0aW9uIHJlcXVpcmVQcmVsb2FkKGNodW5rSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGhyZWYgPSBfX3dlYnBhY2tfZ2V0X3NjcmlwdF9maWxlbmFtZV9fKGNodW5rSWQpO1xuICAgIGNsZWFudXBMaW5rVGFncy5wdXNoKGluc2VydExpbmtUYWcoaHJlZiwgcmVsKSk7XG5cbiAgICByZXR1cm4gZmFrZVByb21pc2U7XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBsb2FkZXIoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gSWdub3JlIGFueSBlcnJvcnNcbiAgfVxuXG4gIC8vIFJlc3RvcmUgcmVhbCB3ZWJwYWNrIHJlcXVpcmUgZW5zdXJlXG4gIF9fd2VicGFja19yZXF1aXJlX18uZSA9IHJlcXVpcmVFbnN1cmU7XG5cbiAgcmV0dXJuICgpID0+IHtcbiAgICBmb3IgKGNvbnN0IGNsZWFudXBMaW5rVGFnIG9mIGNsZWFudXBMaW5rVGFncykge1xuICAgICAgY2xlYW51cExpbmtUYWcoKTtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBsb2FkZXJQcmVsb2FkU3RyYXRlZ3koe1xuICBsb2FkZXIsXG59OiBQaWNrPFByZWxvYWRTdHJhdGVneU9wdGlvbnMsICdsb2FkZXInPik6IENsZWFudXAge1xuICBsb2FkZXIoKTtcblxuICByZXR1cm4gbm9vcENsZWFudXA7XG59XG5cbmV4cG9ydCB0eXBlIFByZWxvYWRBc3NldE9wdGlvbnMgPSB7XG4gIGxvYWRlcjogTG9hZGVyPHVua25vd24+O1xuICBtb2R1bGVJZDogc3RyaW5nO1xuICBwcmlvcml0eT86IFByZWxvYWRQcmlvcml0eTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVsb2FkQXNzZXQoe1xuICBsb2FkZXIsXG4gIG1vZHVsZUlkLFxuICBwcmlvcml0eSxcbn06IFByZWxvYWRBc3NldE9wdGlvbnMpOiBDbGVhbnVwIHtcbiAgaWYgKGlzTm9kZUVudmlyb25tZW50KCkpIHJldHVybiBub29wQ2xlYW51cDtcblxuICBHbG9iYWxSZWFjdExvb3NlbHlMYXp5UHJvZmlsZXIuY3VycmVudD8ub25QcmVsb2FkKG1vZHVsZUlkLCBwcmlvcml0eSk7XG5cbiAgY29uc3QgcmVsID0gcHJpb3JpdHkgPT09IFBSSU9SSVRZLkhJR0ggPyAncHJlbG9hZCcgOiAncHJlZmV0Y2gnO1xuICBjb25zdCBwcmVsb2FkU3RyYXRlZ2llcyA9IFtcbiAgICBtYW5pZmVzdFByZWxvYWRTdHJhdGVneSxcbiAgICB3ZWJwYWNrUHJlbG9hZFN0cmF0ZWd5LFxuICAgIGxvYWRlclByZWxvYWRTdHJhdGVneSxcbiAgXTtcblxuICBmb3IgKGNvbnN0IHN0cmF0ZWd5IG9mIHByZWxvYWRTdHJhdGVnaWVzKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBzdHJhdGVneSh7IGxvYWRlciwgbW9kdWxlSWQsIHJlbCB9KTtcbiAgICB9IGNhdGNoIChfKSB7XG4gICAgICAvLyBUcnkgbmV4dCBzdHJhdGVneS4uLlxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBub29wQ2xlYW51cDtcbn1cbiJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0Esa0JBQWtCLFFBQVEsOEJBQThCO0FBRWpFLFNBQVNDLFdBQVcsUUFBUSxlQUFlO0FBRTNDLFNBQVNDLFNBQVMsUUFBUSxjQUFjO0FBQ3hDLFNBQVNDLGlCQUFpQixRQUFRLGFBQWE7QUFFL0MsU0FBU0MsUUFBUSxRQUFRLGNBQWM7QUFJdkMsU0FBU0MsYUFBYSxRQUFRLFNBQVM7QUFDdkMsU0FBU0MsOEJBQThCLFFBQVEsZ0JBQWdCO0FBYS9ELE9BQU8sU0FBU0MsdUJBQXVCQSxDQUFDO0VBQ3RDQyxRQUFRO0VBQ1JDO0FBQ2dELENBQUMsRUFBVztFQUM1RCxNQUFNO0lBQUVDO0VBQVMsQ0FBQyxHQUFHUixTQUFTLENBQUMsQ0FBQztFQUNoQyxNQUFNUyxNQUFNLEdBQUdYLGtCQUFrQixDQUFDVSxRQUFRLEVBQUVGLFFBQVEsQ0FBQztFQUNyRCxJQUFJLENBQUNHLE1BQU0sRUFBRTtJQUNYLE1BQU0sSUFBSUMsS0FBSyxDQUFDLDhCQUE4QixDQUFDO0VBQ2pEO0VBRUEsTUFBTUMsZUFBZSxHQUFHRixNQUFNLENBQUNHLEdBQUcsQ0FBQ0MsR0FBRyxJQUFJVixhQUFhLENBQUNVLEdBQUcsRUFBRU4sR0FBRyxDQUFDLENBQUM7RUFFbEUsT0FBTyxNQUFNO0lBQ1gsS0FBSyxNQUFNTyxjQUFjLElBQUlILGVBQWUsRUFBRTtNQUM1Q0csY0FBYyxDQUFDLENBQUM7SUFDbEI7RUFDRixDQUFDO0FBQ0g7QUFFQSxNQUFNQyxXQUFXLEdBQUc7RUFDbEJDLElBQUksRUFBRUEsQ0FBQSxLQUFNRCxXQUFXO0VBQ3ZCRSxLQUFLLEVBQUVBLENBQUEsS0FBTUYsV0FBVztFQUN4QkcsT0FBTyxFQUFFQSxDQUFBLEtBQU1IO0FBQ2pCLENBQUM7QUFFRCxPQUFPLFNBQVNJLHNCQUFzQkEsQ0FBQztFQUNyQ0MsTUFBTTtFQUNOYjtBQUM4QyxDQUFDLEVBQVc7RUFDMUQsSUFDRSxPQUFPYyxtQkFBbUIsS0FBSyxXQUFXLElBQzFDLE9BQU9DLCtCQUErQixLQUFLLFdBQVcsRUFFdEQsTUFBTSxJQUFJWixLQUFLLENBQUMsOEJBQThCLENBQUM7O0VBRWpEO0VBQ0EsTUFBTWEsYUFBYSxHQUFHRixtQkFBbUIsQ0FBQ0csQ0FBQztFQUMzQyxNQUFNYixlQUEwQixHQUFHLEVBQUU7RUFDckNVLG1CQUFtQixDQUFDRyxDQUFDLEdBQUcsU0FBU0MsY0FBY0EsQ0FBQ0MsT0FBZSxFQUFFO0lBQy9ELE1BQU1DLElBQUksR0FBR0wsK0JBQStCLENBQUNJLE9BQU8sQ0FBQztJQUNyRGYsZUFBZSxDQUFDaUIsSUFBSSxDQUFDekIsYUFBYSxDQUFDd0IsSUFBSSxFQUFFcEIsR0FBRyxDQUFDLENBQUM7SUFFOUMsT0FBT1EsV0FBVztFQUNwQixDQUFDO0VBRUQsSUFBSTtJQUNGSyxNQUFNLENBQUMsQ0FBQztFQUNWLENBQUMsQ0FBQyxPQUFPUyxHQUFHLEVBQUU7SUFDWjtFQUFBOztFQUdGO0VBQ0FSLG1CQUFtQixDQUFDRyxDQUFDLEdBQUdELGFBQWE7RUFFckMsT0FBTyxNQUFNO0lBQ1gsS0FBSyxNQUFNVCxjQUFjLElBQUlILGVBQWUsRUFBRTtNQUM1Q0csY0FBYyxDQUFDLENBQUM7SUFDbEI7RUFDRixDQUFDO0FBQ0g7QUFFQSxPQUFPLFNBQVNnQixxQkFBcUJBLENBQUM7RUFDcENWO0FBQ3NDLENBQUMsRUFBVztFQUNsREEsTUFBTSxDQUFDLENBQUM7RUFFUixPQUFPckIsV0FBVztBQUNwQjtBQVFBLE9BQU8sU0FBU2dDLFlBQVlBLENBQUM7RUFDM0JYLE1BQU07RUFDTmQsUUFBUTtFQUNSMEI7QUFDbUIsQ0FBQyxFQUFXO0VBQUEsSUFBQUMscUJBQUE7RUFDL0IsSUFBSWhDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxPQUFPRixXQUFXO0VBRTNDLENBQUFrQyxxQkFBQSxHQUFBN0IsOEJBQThCLENBQUM4QixPQUFPLGFBQXRDRCxxQkFBQSxDQUF3Q0UsU0FBUyxDQUFDN0IsUUFBUSxFQUFFMEIsUUFBUSxDQUFDO0VBRXJFLE1BQU16QixHQUFHLEdBQUd5QixRQUFRLEtBQUs5QixRQUFRLENBQUNrQyxJQUFJLEdBQUcsU0FBUyxHQUFHLFVBQVU7RUFDL0QsTUFBTUMsaUJBQWlCLEdBQUcsQ0FDeEJoQyx1QkFBdUIsRUFDdkJjLHNCQUFzQixFQUN0QlcscUJBQXFCLENBQ3RCO0VBRUQsS0FBSyxNQUFNUSxRQUFRLElBQUlELGlCQUFpQixFQUFFO0lBQ3hDLElBQUk7TUFDRixPQUFPQyxRQUFRLENBQUM7UUFBRWxCLE1BQU07UUFBRWQsUUFBUTtRQUFFQztNQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDLENBQUMsT0FBT2dDLENBQUMsRUFBRTtNQUNWO0lBQUE7RUFFSjtFQUVBLE9BQU94QyxXQUFXO0FBQ3BCIiwiaWdub3JlTGlzdCI6W119