"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.findChangedNodesFromTransaction = void 0;
var _utils = require("@atlaskit/editor-prosemirror/utils");
var _platformFeatureFlags = require("@atlaskit/platform-feature-flags");
/**
 * Finds all top level nodes affected by the transaction
 * Uses from/to positions in transaction's steps to work out which nodes will
 * be changed by the transaction
 */
var findChangedNodesFromTransaction = exports.findChangedNodesFromTransaction = function findChangedNodesFromTransaction(tr) {
  var nodes = [];
  var steps = tr.steps || [];
  steps.forEach(function (step) {
    step.getMap().forEach(function (oldStart, oldEnd, newStart, newEnd) {
      tr.doc.nodesBetween(newStart, Math.min(newEnd, tr.doc.content.size), function (node) {
        var nodeToCheck = node;
        if ((0, _platformFeatureFlags.fg)('cc_complexit_fe_improve_node_validation')) {
          var schema = tr.selection.$from.doc.type.schema;
          var parentNode = (0, _utils.findParentNode)(function (node) {
            return node.type !== schema.nodes.paragraph;
          })(tr.selection);
          nodeToCheck = parentNode ? parentNode.node : node;
        }
        if (!nodes.find(function (n) {
          return n === nodeToCheck;
        })) {
          nodes.push(nodeToCheck);
        }
        return false;
      });
    });
  });
  return nodes;
};