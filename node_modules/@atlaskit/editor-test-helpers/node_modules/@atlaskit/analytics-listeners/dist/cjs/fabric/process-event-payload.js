"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var analytics_gas_types_1 = require("@atlaskit/analytics-gas-types");
var analytics_namespaced_context_1 = require("@atlaskit/analytics-namespaced-context");
var lodash_merge_1 = tslib_1.__importDefault(require("lodash.merge"));
var FabricElementsListener_1 = require("./FabricElementsListener");
var FabricEditorListener_1 = require("./FabricEditorListener");
var extractFieldsFromContext = function (fieldsToPick) { return function (contexts) {
    return contexts
        .map(function (ctx) {
        return fieldsToPick.reduce(function (result, key) {
            var _a;
            return ctx[key] ? lodash_merge_1.default(result, (_a = {}, _a[key] = ctx[key], _a)) : result;
        }, {});
    })
        .reduce(function (result, item) { return lodash_merge_1.default(result, item); }, {});
}; };
var fieldExtractor = function (contextKey) {
    return extractFieldsFromContext([
        'source',
        'objectType',
        'objectId',
        'containerType',
        'containerId',
        contextKey,
    ]);
};
var getContextKey = function (tag) {
    switch (tag) {
        case FabricElementsListener_1.ELEMENTS_TAG:
            return analytics_namespaced_context_1.ELEMENTS_CONTEXT;
        case FabricEditorListener_1.EDITOR_TAG:
            return analytics_namespaced_context_1.EDITOR_CONTEXT;
        default:
            return '';
    }
};
var updatePayloadWithContext = function (primaryTag, event) {
    if (event.context.length === 0) {
        return tslib_1.__assign({ source: analytics_gas_types_1.DEFAULT_SOURCE }, event.payload);
    }
    var contextKey = getContextKey(primaryTag) || 'attributes';
    var _a = fieldExtractor(contextKey)(event.context), _b = contextKey, attributes = _a[_b], fields = tslib_1.__rest(_a, [typeof _b === "symbol" ? _b : _b + ""]);
    if (attributes) {
        event.payload.attributes = lodash_merge_1.default(attributes, event.payload.attributes || {});
    }
    return tslib_1.__assign(tslib_1.__assign({ source: analytics_gas_types_1.DEFAULT_SOURCE }, fields), event.payload);
};
var addTags = function (tags, originalTags) {
    if (originalTags === void 0) { originalTags = []; }
    var mergedTags = new Set(tslib_1.__spread(originalTags, tags));
    return Array.from(mergedTags);
};
/**
 * The primary tag is used for matching the analytics event payload
 * with its context.
 */
function getPrimaryTag(tags) {
    if (typeof tags === 'string') {
        return tags;
    }
    if (!tags.length) {
        throw new Error('Empty tags string array. Unable to match analytics event payload with context');
    }
    return tags[0];
}
exports.processEventPayload = function (event, tags) {
    var primaryTag = getPrimaryTag(tags);
    var tagsArray = typeof tags === 'string' ? [tags] : tags;
    return tslib_1.__assign(tslib_1.__assign({}, updatePayloadWithContext(primaryTag, event)), { tags: addTags(tagsArray, event.payload.tags) });
};
//# sourceMappingURL=process-event-payload.js.map