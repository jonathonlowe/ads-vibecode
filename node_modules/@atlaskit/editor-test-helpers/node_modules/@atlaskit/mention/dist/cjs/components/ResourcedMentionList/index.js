"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var react_1 = tslib_1.__importDefault(require("react"));
var analytics_next_1 = require("@atlaskit/analytics-next");
var id_1 = tslib_1.__importDefault(require("../../util/id"));
var logger_1 = tslib_1.__importDefault(require("../../util/logger"));
var MentionList_1 = tslib_1.__importDefault(require("../MentionList"));
var TeamMentionHighlight_1 = tslib_1.__importDefault(require("../TeamMentionHighlight"));
var TeamMentionHighlightController_1 = tslib_1.__importDefault(require("../TeamMentionHighlight/TeamMentionHighlightController"));
var analytics_1 = require("../../util/analytics");
function applyPresence(mentions, presences) {
    var updatedMentions = [];
    for (var i = 0; i < mentions.length; i++) {
        // Shallow copy
        var mention = tslib_1.__assign({}, mentions[i]);
        var presence = presences[mention.id];
        if (presence) {
            mention.presence = presence;
        }
        updatedMentions.push(mention);
    }
    return updatedMentions;
}
function extractPresences(mentions) {
    var presences = {};
    for (var i = 0; i < mentions.length; i++) {
        var mention = mentions[i];
        if (mention.presence) {
            presences[mention.id] = mention.presence;
        }
    }
    return presences;
}
var ResourcedMentionListWithoutAnalytics = /** @class */ (function (_super) {
    tslib_1.__extends(ResourcedMentionListWithoutAnalytics, _super);
    function ResourcedMentionListWithoutAnalytics(props) {
        var _this = _super.call(this, props) || this;
        // API
        _this.selectNext = function () {
            if (_this.mentionListRef) {
                _this.mentionListRef.selectNext();
            }
        };
        _this.selectPrevious = function () {
            if (_this.mentionListRef) {
                _this.mentionListRef.selectPrevious();
            }
        };
        _this.selectIndex = function (index, callback) {
            if (_this.mentionListRef) {
                _this.mentionListRef.selectIndex(index, callback);
            }
        };
        _this.selectId = function (id, callback) {
            if (_this.mentionListRef) {
                _this.mentionListRef.selectId(id, callback);
            }
        };
        _this.chooseCurrentSelection = function () {
            if (_this.mentionListRef) {
                _this.mentionListRef.chooseCurrentSelection();
            }
        };
        _this.mentionsCount = function () {
            if (_this.mentionListRef) {
                return _this.mentionListRef.mentionsCount();
            }
            return 0;
        };
        // internal, used for callbacks
        _this.filterChange = function (mentions) {
            // Retain known presence
            var currentPresences = extractPresences(_this.state.mentions);
            _this.setState({
                resourceError: undefined,
                mentions: applyPresence(mentions, currentPresences),
            });
            _this.refreshPresences(mentions);
        };
        _this.sendAnalytics = function (event, actionSubject, action) {
            if (event === analytics_1.SLI_EVENT_TYPE) {
                analytics_1.fireSliAnalyticsEvent(_this.props)(actionSubject, action);
            }
        };
        _this.filterError = function (error) {
            logger_1.default('ak-resourced-mentions-list._filterError', error);
            _this.setState({
                resourceError: error,
            });
        };
        _this.presenceUpdate = function (presences) {
            _this.setState({
                mentions: applyPresence(_this.state.mentions, presences),
            });
        };
        _this.notifySelection = function (mention) {
            _this.props.resourceProvider.recordMentionSelection(mention);
            if (_this.props.onSelection) {
                _this.props.onSelection(mention);
            }
        };
        _this.handleMentionListRef = function (ref) {
            _this.mentionListRef = ref;
        };
        _this.closeHighlight = function () {
            TeamMentionHighlightController_1.default.registerClosed();
        };
        _this.mentionsHighlight = function () {
            var mentions = _this.state.mentions;
            var _a = _this.props, isTeamMentionHighlightEnabled = _a.isTeamMentionHighlightEnabled, createTeamPath = _a.createTeamPath;
            var enabledViaLocalStorage = TeamMentionHighlightController_1.default.isHighlightEnabled();
            var shouldShow = enabledViaLocalStorage &&
                isTeamMentionHighlightEnabled &&
                mentions &&
                mentions.length > 0;
            if (!shouldShow) {
                return null;
            }
            return (react_1.default.createElement(TeamMentionHighlight_1.default, { createTeamLink: createTeamPath, onClose: _this.closeHighlight }));
        };
        _this.subscriberKey = id_1.default('ak-resourced-mention-list');
        _this.state = {
            resourceError: undefined,
            mentions: [],
        };
        _this.applyPropChanges({}, props);
        return _this;
    }
    ResourcedMentionListWithoutAnalytics.prototype.componentDidMount = function () {
        this.subscribeMentionProvider(this.props.resourceProvider);
        this.subscribePresenceProvider(this.props.presenceProvider);
    };
    ResourcedMentionListWithoutAnalytics.prototype.UNSAFE_componentWillReceiveProps = function (nextProps) {
        this.applyPropChanges(this.props, nextProps);
    };
    ResourcedMentionListWithoutAnalytics.prototype.componentWillUnmount = function () {
        this.unsubscribeMentionProvider(this.props.resourceProvider);
        this.unsubscribePresenceProvider(this.props.presenceProvider);
    };
    // internal
    ResourcedMentionListWithoutAnalytics.prototype.subscribeMentionProvider = function (mentionProvider) {
        if (mentionProvider) {
            mentionProvider.subscribe(this.subscriberKey, this.filterChange, this.filterError, undefined, undefined, this.sendAnalytics);
        }
    };
    ResourcedMentionListWithoutAnalytics.prototype.subscribePresenceProvider = function (presenceProvider) {
        if (presenceProvider) {
            presenceProvider.subscribe(this.subscriberKey, this.presenceUpdate);
        }
    };
    ResourcedMentionListWithoutAnalytics.prototype.unsubscribeMentionProvider = function (mentionProvider) {
        if (mentionProvider) {
            mentionProvider.unsubscribe(this.subscriberKey);
        }
    };
    ResourcedMentionListWithoutAnalytics.prototype.unsubscribePresenceProvider = function (presenceProvider) {
        if (presenceProvider) {
            presenceProvider.unsubscribe(this.subscriberKey);
        }
    };
    ResourcedMentionListWithoutAnalytics.prototype.applyPropChanges = function (prevProps, nextProps) {
        var oldResourceProvider = prevProps.resourceProvider;
        var oldPresenceProvider = prevProps.presenceProvider;
        var oldQuery = prevProps.query;
        var newResourceProvider = nextProps.resourceProvider;
        var newPresenceProvider = nextProps.presenceProvider;
        var newQuery = nextProps.query;
        var resourceProviderChanged = oldResourceProvider !== newResourceProvider;
        var queryChanged = oldQuery !== newQuery;
        var canFilter = !!(typeof newQuery === 'string' && newResourceProvider);
        var shouldFilter = canFilter && (queryChanged || resourceProviderChanged);
        // resource provider
        if (resourceProviderChanged) {
            this.unsubscribeMentionProvider(oldResourceProvider);
            this.subscribeMentionProvider(newResourceProvider);
        }
        // presence provider
        if (oldPresenceProvider !== newPresenceProvider) {
            this.unsubscribePresenceProvider(oldPresenceProvider);
            this.subscribePresenceProvider(newPresenceProvider);
        }
        if (shouldFilter) {
            newResourceProvider.filter(newQuery);
        }
    };
    ResourcedMentionListWithoutAnalytics.prototype.refreshPresences = function (mentions) {
        if (this.props.presenceProvider) {
            var ids = mentions.map(function (mention) { return mention.id; });
            this.props.presenceProvider.refreshPresence(ids);
        }
    };
    ResourcedMentionListWithoutAnalytics.prototype.render = function () {
        var _a = this.state, mentions = _a.mentions, resourceError = _a.resourceError;
        return (react_1.default.createElement(MentionList_1.default, { initialHighlightElement: this.mentionsHighlight(), mentions: mentions, resourceError: resourceError, onSelection: this.notifySelection, ref: this.handleMentionListRef }));
    };
    return ResourcedMentionListWithoutAnalytics;
}(react_1.default.PureComponent));
exports.ResourcedMentionListWithoutAnalytics = ResourcedMentionListWithoutAnalytics;
var ResourcedMentionList = analytics_next_1.withAnalyticsEvents({})(ResourcedMentionListWithoutAnalytics);
exports.default = ResourcedMentionList;
//# sourceMappingURL=index.js.map