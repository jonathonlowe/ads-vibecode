"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.CHRSummary = exports.CHRReporter = void 0;
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var _defineProperty4 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));
var _platformFeatureFlags = require("@atlaskit/platform-feature-flags");
var _selfMeasurements = require("../self-measurements");
var _utils = require("./utils");
var _CHRSummary;
var CHRSummary = exports.CHRSummary = /*#__PURE__*/function () {
  function CHRSummary() {
    (0, _classCallCheck2.default)(this, CHRSummary);
    (0, _defineProperty4.default)(this, "bundles", (0, _defineProperty4.default)((0, _defineProperty4.default)((0, _defineProperty4.default)({}, _utils.MEMORY_KEY, 0), _utils.DISK_KEY, 0), _utils.NETWORK_KEY, 0));
    (0, _defineProperty4.default)(this, "bundlesCount", 0);
    (0, _defineProperty4.default)(this, "size", (0, _defineProperty4.default)((0, _defineProperty4.default)((0, _defineProperty4.default)({}, _utils.MEMORY_KEY, 0), _utils.DISK_KEY, 0), _utils.NETWORK_KEY, 0));
    (0, _defineProperty4.default)(this, "sizeTotal", 0);
    this.add = (0, _selfMeasurements.withProfiling)(this.add.bind(this));
  }
  return (0, _createClass2.default)(CHRSummary, [{
    key: "add",
    value: function add(asset) {
      var encodedSize = asset.encodedSize || 0;
      var type = (0, _utils.calculateTransferType)(asset.name, asset.initiatorType, asset.duration, asset.transferSize);
      if (type === null) {
        return;
      }
      this.bundles[type] += 1;
      this.bundlesCount += 1;
      this.size[type] += encodedSize;
      this.sizeTotal += encodedSize;
    }
  }]);
}();
_CHRSummary = CHRSummary;
(0, _defineProperty4.default)(CHRSummary, "makePayload", (0, _selfMeasurements.withProfiling)(function makePayload(summary) {
  var size = summary.size,
    bundlesCount = summary.bundlesCount,
    sizeTotal = summary.sizeTotal;
  var cachedSize = size[_utils.MEMORY_KEY] + size[_utils.DISK_KEY];
  var sizeRatio = (0, _utils.round)(cachedSize / summary.sizeTotal);
  return {
    size: sizeTotal,
    chr: sizeRatio,
    count: bundlesCount
  };
}));
var CHRReporter = exports.CHRReporter = /*#__PURE__*/function () {
  function CHRReporter() {
    (0, _classCallCheck2.default)(this, CHRReporter);
    (0, _defineProperty4.default)(this, "all", new CHRSummary());
    (0, _defineProperty4.default)(this, "allAtlassian", new CHRSummary());
    (0, _defineProperty4.default)(this, "preloaded", new CHRSummary());
    (0, _defineProperty4.default)(this, "defaultAllowedTypes", ['js']);
    this.get = (0, _selfMeasurements.withProfiling)(this.get.bind(this));
  }
  return (0, _createClass2.default)(CHRReporter, [{
    key: "get",
    value: function get(resourceTimings, assetsConfig, SSRDoneTime) {
      var _this = this;
      try {
        if (resourceTimings === null) {
          return null;
        }
        resourceTimings.forEach(function (entry) {
          if (!(0, _utils.checkIfTimingsAvailable)(entry)) {
            return;
          }
          var hasNanValues = (0, _platformFeatureFlags.fg)('platform_ufo_assets_check_for_nan') ? entry.encodedSize === undefined || entry.encodedSize === null : false;
          if (entry.encodedSize === entry.decodedSize || hasNanValues) {
            // incorrectly reported or lack of size
            return;
          }
          var type = (0, _utils.getTypeOfRequest)(entry);
          if (!(assetsConfig.allowedTypes || _this.defaultAllowedTypes).includes(type)) {
            return;
          }
          if (assetsConfig.classification.all) {
            _this.all.add(entry);
          }
          if (assetsConfig.classification.allAtlassian({
            entry: entry
          })) {
            _this.allAtlassian.add(entry);
          }
          if (assetsConfig.classification.preloaded({
            entry: entry,
            SSRDoneTime: SSRDoneTime
          })) {
            _this.preloaded.add(entry);
          }
        });
        if (this.all.bundlesCount === 0) {
          return null;
        }
        var CHRData = {
          all: CHRSummary.makePayload(this.all),
          allAtlassian: CHRSummary.makePayload(this.allAtlassian),
          preloaded: CHRSummary.makePayload(this.preloaded)
        };
        return CHRData;
      } catch (error) {
        return null;
      }
    }
  }]);
}();