"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));
var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _selfMeasurements = require("../../../../../self-measurements");
var _isViewportEntryData = _interopRequireDefault(require("../../utils/is-viewport-entry-data"));
var _taskYield = _interopRequireDefault(require("../../utils/task-yield"));
var _calcUnionArea = _interopRequireDefault(require("./calc-union-area"));
var calculateTTVCPercentiles = (0, _selfMeasurements.withProfiling)( /*#__PURE__*/function () {
  var _calculateTTVCPercentiles = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(_ref) {
    var orderedEntries, viewport, percentiles, startTime, sortedPercentiles, viewportArea, checkpoints, activeRects, removeActiveRect, domElementsBuffer, i, iEntry, iEntryData, rect, elementName, exclusionArea, currentArea, currVCPercent, matchesAnyCheckpoints, _checkpoint, domElements;
    return _regenerator.default.wrap(function _callee$(_context) {
      while (1) switch (_context.prev = _context.next) {
        case 0:
          orderedEntries = _ref.orderedEntries, viewport = _ref.viewport, percentiles = _ref.percentiles, startTime = _ref.startTime;
          sortedPercentiles = (0, _toConsumableArray2.default)(percentiles).sort(function (a, b) {
            return a - b;
          });
          viewportArea = viewport.width * viewport.height;
          checkpoints = {};
          activeRects = orderedEntries.filter(function (e) {
            return (0, _isViewportEntryData.default)(e.data);
          }).map(function (e) {
            return e.data.rect;
          });
          removeActiveRect = function removeActiveRect(rectToRemove) {
            var index = activeRects.indexOf(rectToRemove);
            // Check if the element exists in the array
            if (index !== -1) {
              // Remove the element at the found index
              activeRects.splice(index, 1);
            }
          };
          domElementsBuffer = new Set();
          i = 0;
        case 8:
          if (!(i < orderedEntries.length)) {
            _context.next = 36;
            break;
          }
          iEntry = orderedEntries[i];
          iEntryData = iEntry.data;
          if ((0, _isViewportEntryData.default)(iEntryData)) {
            _context.next = 13;
            break;
          }
          return _context.abrupt("continue", 33);
        case 13:
          rect = iEntryData.rect, elementName = iEntryData.elementName;
          domElementsBuffer.add(elementName);
          removeActiveRect(rect);
          exclusionArea = (0, _calcUnionArea.default)(activeRects);
          currentArea = viewportArea - exclusionArea;
          currVCPercent = Math.round(currentArea / viewportArea * 100);
          matchesAnyCheckpoints = false;
        case 20:
          if (!(sortedPercentiles.length > 0 && currVCPercent >= sortedPercentiles[0])) {
            _context.next = 29;
            break;
          }
          _checkpoint = sortedPercentiles.shift();
          domElements = (0, _toConsumableArray2.default)(domElementsBuffer);
          if (_checkpoint) {
            _context.next = 25;
            break;
          }
          return _context.abrupt("break", 29);
        case 25:
          matchesAnyCheckpoints = true;
          checkpoints[_checkpoint.toString()] = {
            t: Math.round(iEntry.time - startTime),
            e: domElements
          };
          _context.next = 20;
          break;
        case 29:
          if (matchesAnyCheckpoints) {
            domElementsBuffer.clear();
          }
          if (!(i % 500 === 0)) {
            _context.next = 33;
            break;
          }
          _context.next = 33;
          return (0, _taskYield.default)();
        case 33:
          i++;
          _context.next = 8;
          break;
        case 36:
          return _context.abrupt("return", checkpoints);
        case 37:
        case "end":
          return _context.stop();
      }
    }, _callee);
  }));
  function calculateTTVCPercentiles(_x) {
    return _calculateTTVCPercentiles.apply(this, arguments);
  }
  return calculateTTVCPercentiles;
}(), ['vc']);
var _default = exports.default = calculateTTVCPercentiles;